{% extends "base.html" %}

{% block title %}{{ contest.title }} - Nekonic OJ{% endblock title %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-lg-8">
      <!-- 대회 헤더 -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <h1 class="h2 mb-2">{{ contest.title }}</h1>
              <p class="text-muted mb-0">
                <i class="bi bi-person"></i> {{ contest.creator_username }}
              </p>
            </div>
            <div>
              {% if contest_phase == "upcoming" %}
              <span class="badge bg-info fs-6">예정</span>
              {% elif contest_phase == "active" %}
              <span class="badge bg-success fs-6">진행 중</span>
              {% elif contest_phase == "ended" %}
              <span class="badge bg-secondary fs-6">종료</span>
              {% endif %}
            </div>
          </div>

          <div class="row text-center mb-3">
            <div class="col-md-4 mb-2">
              <div class="p-3 border rounded">
                <i class="bi bi-calendar-event text-primary"></i>
                <div class="small text-muted mt-1">시작</div>
                <div class="fw-bold">{{ contest.start_time }}</div>
              </div>
            </div>
            <div class="col-md-4 mb-2">
              <div class="p-3 border rounded">
                <i class="bi bi-calendar-check text-danger"></i>
                <div class="small text-muted mt-1">종료</div>
                <div class="fw-bold">{{ contest.end_time }}</div>
              </div>
            </div>
            <div class="col-md-4 mb-2">
              <div class="p-3 border rounded">
                <i class="bi bi-trophy text-warning"></i>
                <div class="small text-muted mt-1">참가자</div>
                <div class="fw-bold">{{ participant_count }}명</div>
              </div>
            </div>
          </div>

          <hr>

          <div class="mb-3">
            <h5>대회 설명</h5>
            <p>{{ contest.description }}</p>
          </div>

          <div class="mb-2">
            <span class="badge bg-primary">{{ contest.contest_type }}</span>
          </div>
        </div>
      </div>

      <!-- 문제 목록 -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">문제 목록 ({{ problems|length }}문제)</h5>
        </div>
        <div class="card-body">
          {% if problems %}
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th style="width: 10%;">#</th>
                  <th style="width: 50%;">제목</th>
                  <th style="width: 20%;">배점</th>
                  <th style="width: 20%;">상태</th>
                </tr>
              </thead>
              <tbody>
              {% for problem in problems %}
              <tr>
                <td>{{ problem.problem_order }}</td>
                <td>
                  {% if contest_phase == "active" and is_registered %}
                  <a href="/contests/{{ contest.id }}/problems/{{ problem.problem_id }}">문제 {{ problem.problem_order }}</a>
                  {% else %}
                  문제 {{ problem.problem_order }}
                  {% endif %}
                </td>
                <td>{{ problem.points }}점</td>
                <td>
                  <span class="badge bg-secondary">미시도</span>
                </td>
              </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p class="text-muted mb-0">아직 등록된 문제가 없습니다.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <!-- 참가 신청 -->
      <div class="card mb-4">
        <div class="card-body">
          {% if current_user %}
            {% if is_registered %}
            <div class="alert alert-success mb-0">
              <i class="bi bi-check-circle"></i> 참가 신청 완료
            </div>
            {% if contest_phase == "active" %}
            <a href="/contests/{{ contest.id }}/standings" class="btn btn-primary w-100 mt-3">
              순위표 보기
            </a>
            {% endif %}
            {% elif contest_phase == "upcoming" %}
            <form action="/contests/{{ contest.id }}/register" method="post">
              <button type="submit" class="btn btn-primary w-100">참가 신청</button>
            </form>
            {% elif contest_phase == "active" %}
            <form action="/contests/{{ contest.id }}/register" method="post">
              <button type="submit" class="btn btn-success w-100">지금 참가하기</button>
            </form>
            {% else %}
            <a href="/contests/{{ contest.id }}/standings" class="btn btn-secondary w-100">
              결과 보기
            </a>
            {% endif %}

            <!-- 대회 생성자 또는 관리자에게만 관리 버튼 표시 -->
            {% if current_user.id == contest.created_by or current_user.role == "admin" %}
            <a href="/contests/{{ contest.id }}/manage" class="btn btn-outline-primary w-100 mt-2">
              <i class="bi bi-gear"></i> 대회 관리
            </a>
            {% endif %}
          {% else %}
          <p class="text-muted mb-3">대회에 참가하려면 로그인이 필요합니다.</p>
          <a href="/login" class="btn btn-primary w-100">로그인</a>
          {% endif %}
        </div>
      </div>

      <!-- 대회 규칙 -->
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">대회 규칙</h6>
        </div>
        <div class="card-body">
          {% if contest.contest_type == "ICPC" %}
          <ul class="mb-0">
            <li>문제를 많이 푼 순서대로 순위</li>
            <li>같은 문제 수면 패널티 타임이 적은 팀이 상위</li>
            <li>패널티 = 풀이 시간 + 틀린 횟수 × 20분</li>
            <li>맞춘 문제만 패널티 계산</li>
          </ul>
          {% elif contest.contest_type == "IOI" %}
          <ul class="mb-0">
            <li>각 문제의 점수를 합산</li>
            <li>부분 점수 허용</li>
            <li>총점이 높을수록 상위</li>
          </ul>
          {% elif contest.contest_type == "CTF" %}
          <ul class="mb-0">
            <li>각 문제의 배점을 합산</li>
            <li>First Blood 보너스</li>
            <li>총점이 높을수록 상위</li>
          </ul>
          {% else %}
          <ul class="mb-0">
            <li>연습용 대회입니다</li>
            <li>순위에 영향을 주지 않습니다</li>
          </ul>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

