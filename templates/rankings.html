{% extends "base.html" %}
{% block title %}ë­í‚¹ - Nekonic OJ{% endblock title %}
{% block content %}
<h1 class="mb-4">ë­í‚¹</h1>

<ul class="nav nav-tabs mb-4">
  <li class="nav-item">
    <a class="nav-link {% if not organization_id and not view_type %}active{% endif %}" href="/rankings">ì „ì²´</a>
  </li>
  <li class="nav-item">
    <a class="nav-link {% if view_type == "school" %}active{% endif %}" href="/rankings?view_type=school">í•™êµ</a>
  </li>
  <li class="nav-item">
    <a class="nav-link {% if view_type == "company" %}active{% endif %}" href="/rankings?view_type=company">ê¸°ì—…</a>
  </li>
  <li class="nav-item">
    <a class="nav-link {% if view_type == "club" %}active{% endif %}" href="/rankings?view_type=club">ì†Œëª¨ì„</a>
  </li>
</ul>

{% if view_type %}
{# ì¡°ì§ íƒ€ì…ë³„ ë­í‚¹ í…Œì´ë¸” #}
<div class="alert alert-info mb-4">
  <i class="bi bi-info-circle"></i>
  {% if view_type == "school" %}í•™êµ{% elif view_type == "company" %}ê¸°ì—…{% else %}ì†Œëª¨ì„{% endif %} ê°„ì˜ ë­í‚¹ì„ ë¹„êµí•˜ê³  ìˆìŠµë‹ˆë‹¤.
  ì¡°ì§ ì´ë¦„ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ì¡°ì§ì˜ ì‚¬ìš©ì ë­í‚¹ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
</div>

<div class="table-responsive">
  <table class="table table-hover">
    <thead>
    <tr>
      <th style="width: 80px;">ìˆœìœ„</th>
      <th>
        {% if view_type == "school" %}í•™êµëª…
        {% elif view_type == "company" %}ê¸°ì—…ëª…
        {% else %}ì†Œëª¨ì„ëª…
        {% endif %}
      </th>
      <th style="cursor: pointer; width: 150px;" onclick="sortOrgColumn('total_rating')">
        ë ˆì´íŒ…ì˜ í•©
        {% if sort_by == "total_rating" %}
          {% if sort_order == "desc" %}â–¼{% else %}â–²{% endif %}
        {% endif %}
      </th>
      <th style="cursor: pointer; width: 150px;" onclick="sortOrgColumn('avg_rating')">
        í‰ê·  ë ˆì´íŒ…
        {% if sort_by == "avg_rating" %}
          {% if sort_order == "desc" %}â–¼{% else %}â–²{% endif %}
        {% endif %}
      </th>
      <th style="cursor: pointer; width: 120px;" onclick="sortOrgColumn('member_count')">
        ì¸ì›
        {% if sort_by == "member_count" %}
          {% if sort_order == "desc" %}â–¼{% else %}â–²{% endif %}
        {% endif %}
      </th>
    </tr>
    </thead>
    <tbody>
    {% for org in organization_rankings %}
    <tr style="cursor: pointer;" onclick="window.location.href='/rankings?organization_id={{ org.id }}'">
      <td class="fw-bold">
        {% if org.rank == 1 %}
        <span class="text-warning">ğŸ¥‡ {{ org.rank }}</span>
        {% elif org.rank == 2 %}
        <span class="text-secondary">ğŸ¥ˆ {{ org.rank }}</span>
        {% elif org.rank == 3 %}
        <span style="color: #cd7f32;">ğŸ¥‰ {{ org.rank }}</span>
        {% else %}
        {{ org.rank }}
        {% endif %}
      </td>
      <td>
        <a href="/rankings?organization_id={{ org.id }}" class="text-decoration-none">
          <strong>{{ org.name }}</strong>
        </a>
      </td>
      <td>{{ org.total_rating }}</td>
      <td>{{ org.avg_rating }}</td>
      <td>{{ org.member_count }}ëª…</td>
    </tr>
    {% else %}
    <tr>
      <td colspan="5" class="text-center text-muted py-4">
        ë“±ë¡ëœ
        {% if view_type == "school" %}í•™êµ
        {% elif view_type == "company" %}ê¸°ì—…
        {% else %}ì†Œëª¨ì„
        {% endif %}
        ê°€ ì—†ìŠµë‹ˆë‹¤.
      </td>
    </tr>
    {% endfor %}
    </tbody>
  </table>
</div>

<script>
function sortOrgColumn(column) {
  const urlParams = new URLSearchParams(window.location.search);
  const viewType = urlParams.get('view_type');
  const currentSortBy = urlParams.get('sort_by') || 'avg_rating';
  const currentSortOrder = urlParams.get('sort_order') || 'desc';

  let newSortOrder = 'desc';
  if (currentSortBy === column && currentSortOrder === 'desc') {
    newSortOrder = 'asc';
  }

  window.location.href = `/rankings?view_type=${viewType}&sort_by=${column}&sort_order=${newSortOrder}`;
}
</script>

{% elif organization_id %}
{# íŠ¹ì • ì¡°ì§ì˜ ì‚¬ìš©ì ë­í‚¹ #}
<div class="alert alert-info mb-4">
  <i class="bi bi-building"></i>
  {% for org in organizations_school %}{% if org.id == organization_id %}<strong>{{ org.name }}</strong> (í•™êµ){% endif %}{% endfor %}
  {% for org in organizations_company %}{% if org.id == organization_id %}<strong>{{ org.name }}</strong> (ê¸°ì—…){% endif %}{% endfor %}
  {% for org in organizations_club %}{% if org.id == organization_id %}<strong>{{ org.name }}</strong> (ì†Œëª¨ì„){% endif %}{% endfor %}
  ì˜ ì‚¬ìš©ì ë­í‚¹
  <a href="/rankings" class="alert-link ms-2">â† ëŒì•„ê°€ê¸°</a>
</div>

<div class="table-responsive">
  <table class="table table-hover">
    <thead>
    <tr>
      <th style="width: 80px;">ìˆœìœ„</th>
      <th>ì‚¬ìš©ì</th>
      <th style="cursor: pointer; width: 150px;" onclick="sortColumn('rating')">
        ë ˆì´íŒ…
        {% if sort_by == "rating" %}
          {% if sort_order == "desc" %}â–¼{% else %}â–²{% endif %}
        {% endif %}
      </th>
      <th style="cursor: pointer; width: 150px;" onclick="sortColumn('solved_count')">
        í•´ê²° ë¬¸ì œ ìˆ˜
        {% if sort_by == "solved_count" %}
          {% if sort_order == "desc" %}â–¼{% else %}â–²{% endif %}
        {% endif %}
      </th>
    </tr>
    </thead>
    <tbody>
    {% for entry in rankings %}
    <tr>
      <td class="fw-bold">
        {% if entry.rank == 1 %}
        <span class="text-warning">ğŸ¥‡ {{ entry.rank }}</span>
        {% elif entry.rank == 2 %}
        <span class="text-secondary">ğŸ¥ˆ {{ entry.rank }}</span>
        {% elif entry.rank == 3 %}
        <span style="color: #cd7f32;">ğŸ¥‰ {{ entry.rank }}</span>
        {% else %}
        {{ entry.rank }}
        {% endif %}
      </td>
      <td>{{ entry.username }}</td>
      <td>{{ entry.rating }}</td>
      <td>{{ entry.solved_count }}</td>
    </tr>
    {% else %}
    <tr>
      <td colspan="4" class="text-center text-muted py-4">
        ì´ ì¡°ì§ì— ì†í•œ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.
      </td>
    </tr>
    {% endfor %}
    </tbody>
  </table>
</div>

<script>
function sortColumn(column) {
  const urlParams = new URLSearchParams(window.location.search);
  const organizationId = urlParams.get('organization_id');
  const currentSortBy = urlParams.get('sort_by') || 'rating';
  const currentSortOrder = urlParams.get('sort_order') || 'desc';

  let newSortOrder = 'desc';
  if (currentSortBy === column && currentSortOrder === 'desc') {
    newSortOrder = 'asc';
  }

  window.location.href = `/rankings?organization_id=${organizationId}&sort_by=${column}&sort_order=${newSortOrder}`;
}
</script>

{% else %}
{# ì „ì²´ ì‚¬ìš©ì ë­í‚¹ #}
<div class="table-responsive">
  <table class="table table-hover">
    <thead>
    <tr>
      <th style="width: 80px;">ìˆœìœ„</th>
      <th>ì‚¬ìš©ì</th>
      <th style="cursor: pointer; width: 150px;" onclick="sortColumn('rating')">
        ë ˆì´íŒ…
        {% if sort_by == "rating" %}
          {% if sort_order == "desc" %}â–¼{% else %}â–²{% endif %}
        {% endif %}
      </th>
      <th style="cursor: pointer; width: 150px;" onclick="sortColumn('solved_count')">
        í•´ê²° ë¬¸ì œ ìˆ˜
        {% if sort_by == "solved_count" %}
          {% if sort_order == "desc" %}â–¼{% else %}â–²{% endif %}
        {% endif %}
      </th>
    </tr>
    </thead>
    <tbody>
    {% for entry in rankings %}
    <tr>
      <td class="fw-bold">
        {% if entry.rank == 1 %}
        <span class="text-warning">ğŸ¥‡ {{ entry.rank }}</span>
        {% elif entry.rank == 2 %}
        <span class="text-secondary">ğŸ¥ˆ {{ entry.rank }}</span>
        {% elif entry.rank == 3 %}
        <span style="color: #cd7f32;">ğŸ¥‰ {{ entry.rank }}</span>
        {% else %}
        {{ entry.rank }}
        {% endif %}
      </td>
      <td>{{ entry.username }}</td>
      <td>{{ entry.rating }}</td>
      <td>{{ entry.solved_count }}</td>
    </tr>
    {% else %}
    <tr>
      <td colspan="4" class="text-center text-muted py-4">
        ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.
      </td>
    </tr>
    {% endfor %}
    </tbody>
  </table>
</div>

<script>
function sortColumn(column) {
  const urlParams = new URLSearchParams(window.location.search);
  const currentSortBy = urlParams.get('sort_by') || 'rating';
  const currentSortOrder = urlParams.get('sort_order') || 'desc';

  let newSortOrder = 'desc';
  if (currentSortBy === column && currentSortOrder === 'desc') {
    newSortOrder = 'asc';
  }

  window.location.href = `/rankings?sort_by=${column}&sort_order=${newSortOrder}`;
}
</script>

{% endif %}

{% endblock content %}